<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .metadata-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .metadata-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .metadata-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .section-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            margin: 30px 0 20px 0;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .lesson-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .lesson-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            padding: 15px 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.95em;
        }

        .lesson-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        .lesson-table tr:hover {
            background-color: #f8f9fa;
        }

        .interaction-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .student-student { background: #e3f2fd; color: #1976d2; }
        .teacher-student { background: #f3e5f5; color: #7b1fa2; }
        .student-community { background: #e8f5e8; color: #388e3c; }
        .student-content { background: #fff3e0; color: #f57c00; }

        .duration-badge {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .activity-details {
            line-height: 1.6;
        }

        .activity-title {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .activity-section {
            margin-bottom: 12px;
        }

        .activity-section strong {
            color: #495057;
        }

        .kat-highlight {
            background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .sls-tools {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #28a745;
        }

        .tool-item {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .data-analysis {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 3px solid #ffc107;
        }

        .reasoning-section {
            background: #e3f2fd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .reasoning-title {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .high-level-plan {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .teacher-feedback {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            border-radius: 8px;
            padding: 18px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .teacher-feedback.approved {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        }

        .plan-highlight {
            background: linear-gradient(120deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .lesson-table {
                font-size: 0.9em;
            }
            
            .lesson-table th,
            .lesson-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Lesson Plan Viewer</h1>
            <p>View your generated lesson plans in a beautiful, organized format</p>
        </div>

        <div class="upload-section">
            <h2>Load Your Lesson Plan</h2>
            <p>Select the JSON file generated by your lesson planner</p>
            <div class="file-input-wrapper">
                <input type="file" id="jsonFile" class="file-input" accept=".json">
                <label for="jsonFile" class="file-input-label">üìÅ Choose JSON File</label>
            </div>
            <div id="fileName" style="margin-top: 10px; color: #6c757d;"></div>
        </div>

        <div id="loadingIndicator" class="loading hidden">
            <div class="spinner"></div>
            <p>Loading your lesson plan...</p>
        </div>

        <div id="content" class="content hidden">
            <!-- Content will be dynamically generated here -->
        </div>
    </div>

    <script>
        document.getElementById('jsonFile').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = `Selected: ${file.name}`;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    setTimeout(() => {
                        displayLessonPlan(jsonData);
                        document.getElementById('loadingIndicator').classList.add('hidden');
                        document.getElementById('content').classList.remove('hidden');
                    }, 500);
                } catch (error) {
                    showError('Invalid JSON file. Please check your file format.');
                    document.getElementById('loadingIndicator').classList.add('hidden');
                }
            };
            reader.readAsText(file);
        }

        function displayLessonPlan(data) {
            const content = document.getElementById('content');
            let html = '';

            // Metadata Section
            if (data.lesson_metadata) {
                html += generateMetadataSection(data.lesson_metadata);
            }

            // Generation Process
            if (data.generation_process) {
                html += generateProcessSection(data.generation_process);
            }

            // Errors
            if (data.errors && Object.keys(data.errors).some(key => data.errors[key])) {
                html += generateErrorsSection(data.errors);
            }

            content.innerHTML = html;
        }

        function generateMetadataSection(metadata) {
            return `
                <div class="metadata-section">
                    <h2>üìã Lesson Information</h2>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <div class="metadata-label">Title</div>
                            <div>${metadata.title || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Subject</div>
                            <div>${metadata.subject || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Topic</div>
                            <div>${metadata.topic || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Level/Grade</div>
                            <div>${metadata.level_grade || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Number of Sections</div>
                            <div>${metadata.lesson_structure?.num_sections || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Activities per Section</div>
                            <div>${metadata.lesson_structure?.max_activities_per_section || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Generated</div>
                            <div>${metadata.generation_timestamp || 'N/A'}</div>
                        </div>
                        <div class="metadata-item">
                            <div class="metadata-label">Additional Instructions</div>
                            <div>${metadata.additional_instructions || 'None'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateProcessSection(process) {
            let html = '';

            // High-Level Plan (Step 1)
            if (process.step_1_high_level_plan) {
                html += `
                    <div class="section-header">üéØ Step 1: High-Level Lesson Plan</div>
                    ${generateReasoningSection('High-Level Planning', process.step_1_high_level_plan.reasoning_summary)}
                    
                    <div class="high-level-plan">
                        <div style="white-space: pre-wrap; line-height: 1.6;">
                            ${formatContentWithPlanHighlights(process.step_1_high_level_plan.generated_content)}
                        </div>
                    </div>
                `;
                
                // Teacher Feedback Section
                if (process.step_1_high_level_plan.teacher_feedback && 
                    process.step_1_high_level_plan.teacher_feedback !== 'No additional modifications requested.') {
                    html += `
                        <div class="teacher-feedback">
                            <div style="color: #1976d2; font-weight: bold; margin-bottom: 8px;">üë®‚Äçüè´ Teacher Feedback & Modifications</div>
                            <div style="font-style: italic;">"${process.step_1_high_level_plan.teacher_feedback}"</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="teacher-feedback approved">
                            <div style="color: #2e7d32; font-weight: bold;">‚úÖ Teacher Approval</div>
                            <div style="color: #388e3c;">Plan approved without modifications</div>
                        </div>
                    `;
                }
            }

            // Sections (Step 2)
            if (process.step_2_sections) {
                html += `
                    <div class="section-header">üìù Step 2: Detailed Lesson Sections</div>
                    ${generateReasoningSection('Sections Generation', process.step_2_sections.reasoning_summary)}
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">
                        ${formatContent(process.step_2_sections.generated_content)}
                    </div>
                `;
            }

            // Activities (Step 3)
            if (process.step_3_activities) {
                html += `
                    <div class="section-header">üéØ Step 3: Detailed Activities & Lesson Plan</div>
                    ${generateReasoningSection('Activities Generation', process.step_3_activities.reasoning_summary)}
                `;
                
                // Debug: Check what data we have
                console.log('Activities data:', process.step_3_activities);
                console.log('Structured activities:', process.step_3_activities.structured_activities);
                
                // Check if we have properly structured activities data
                if (process.step_3_activities.structured_activities && 
                    process.step_3_activities.structured_activities.activities && 
                    process.step_3_activities.structured_activities.activities.length > 0) {
                    
                    console.log('Using structured activities');
                    html += generateStructuredActivitiesTable(process.step_3_activities.structured_activities);
                    
                } else {
                    console.log('Using fallback text format - extracting from generated_content');
                    // Try to extract and parse activities from the text response
                    const extractedActivities = extractActivitiesFromText(process.step_3_activities.generated_content);
                    
                    if (extractedActivities.activities.length > 0) {
                        console.log('Successfully extracted activities from text:', extractedActivities);
                        html += generateStructuredActivitiesTable(extractedActivities);
                    } else {
                        console.log('Failed to extract activities, using raw text format');
                        // Ultimate fallback to original text format
                        html += `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                ${parseAndFormatActivities(process.step_3_activities.generated_content)}
                            </div>
                        `;
                    }
                }
            }

            // Legacy support for old format (step_1_sections and step_2_activities)
            if (process.step_1_sections && !process.step_1_high_level_plan) {
                html += `
                    <div class="section-header">üìù Step 1: Lesson Sections</div>
                    ${generateReasoningSection('Sections Generation', process.step_1_sections.reasoning_summary)}
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">
                        ${formatContent(process.step_1_sections.generated_content)}
                    </div>
                `;
            }

            if (process.step_2_activities && !process.step_3_activities) {
                html += `
                    <div class="section-header">üéØ Step 2: Activities & Lesson Plan</div>
                    ${generateReasoningSection('Activities Generation', process.step_2_activities.reasoning_summary)}
                `;
                
                // Handle legacy activities format
                if (process.step_2_activities.structured_activities && 
                    process.step_2_activities.structured_activities.activities && 
                    process.step_2_activities.structured_activities.activities.length > 0) {
                    
                    html += generateStructuredActivitiesTable(process.step_2_activities.structured_activities);
                    
                } else {
                    const extractedActivities = extractActivitiesFromText(process.step_2_activities.generated_content);
                    
                    if (extractedActivities.activities.length > 0) {
                        html += generateStructuredActivitiesTable(extractedActivities);
                    } else {
                        html += `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                ${parseAndFormatActivities(process.step_2_activities.generated_content)}
                            </div>
                        `;
                    }
                }
            }

            return html;
        }

        function extractActivitiesFromText(content) {
            const extractedData = {
                selected_sls_tools: [],
                recommended_kat: [],
                activities: []
            };
            
            console.log('Starting extraction from content');
            
            // First, let's split by the main sections
            const sections = content.split(/\*\*(SELECTED SLS TOOLS|CONFIRMED KEY APPLICATIONS|LESSON PLAN ACTIVITIES)/);
            
            // Find SLS Tools section
            for (let i = 0; i < sections.length; i++) {
                if (sections[i] && sections[i].includes('SELECTED SLS TOOLS')) {
                    const slsSection = sections[i + 1];
                    if (slsSection) {
                        const lines = slsSection.split('\n');
                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (trimmed && trimmed.match(/^\d+\./) && trimmed.length > 10) {
                                extractedData.selected_sls_tools.push(trimmed);
                            }
                        }
                    }
                    break;
                }
            }
            
            // Find KAT section
            for (let i = 0; i < sections.length; i++) {
                if (sections[i] && (sections[i].includes('CONFIRMED KEY APPLICATIONS') || sections[i].includes('RECOMMENDED KEY APPLICATIONS'))) {
                    const katSection = sections[i + 1];
                    if (katSection) {
                        const lines = katSection.split('\n');
                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (trimmed && trimmed.match(/^\d+\./) && trimmed.length > 10) {
                                extractedData.recommended_kat.push(trimmed);
                            }
                        }
                    }
                    break;
                }
            }
            
            // Find and parse activities section
            const activitiesMatch = content.match(/\*\*LESSON PLAN ACTIVITIES:\*\*(.*)/s);
            if (activitiesMatch) {
                const activitiesContent = activitiesMatch[1];
                console.log('Found activities content');
                
                // Split by "---" or "Activity X:" patterns
                const activityBlocks = activitiesContent.split(/(?=Activity\s+\d+:)|---/).filter(block => block.trim());
                
                console.log('Found', activityBlocks.length, 'activity blocks');
                
                activityBlocks.forEach((block, index) => {
                    const lines = block.trim().split('\n');
                    if (lines.length === 0) return;
                    
                    // Look for activity title in the first few lines
                    let activityTitle = '';
                    let startIndex = 0;
                    
                    for (let i = 0; i < Math.min(3, lines.length); i++) {
                        const line = lines[i].trim();
                        if (line.match(/^Activity\s+\d+:/i)) {
                            activityTitle = line;
                            startIndex = i + 1;
                            break;
                        }
                    }
                    
                    if (!activityTitle) {
                        console.log('No activity title found in block', index);
                        return;
                    }
                    
                    console.log('Processing activity:', activityTitle);
                    
                    const activity = {
                        title: activityTitle,
                        section: '',
                        interaction_type: '',
                        duration: '',
                        learning_objectives: [],
                        instructions: '',
                        kat_alignment: '',
                        sls_tools: '',
                        data_analysis: '',
                        teaching_notes: ''
                    };
                    
                    let currentField = '';
                    let currentContent = [];
                    
                    for (let i = startIndex; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (line.startsWith('Section:')) {
                            activity.section = line.replace('Section:', '').trim();
                        } else if (line.startsWith('Interaction Type:')) {
                            activity.interaction_type = line.replace('Interaction Type:', '').trim();
                        } else if (line.startsWith('Duration:')) {
                            activity.duration = line.replace('Duration:', '').trim();
                        } else if (line === 'Learning Objectives:') {
                            currentField = 'learning_objectives';
                            currentContent = [];
                        } else if (line === 'Instructions:') {
                            if (currentField === 'learning_objectives') {
                                activity.learning_objectives = currentContent.filter(l => l.startsWith('‚Ä¢')).map(l => l.substring(1).trim());
                            }
                            currentField = 'instructions';
                            currentContent = [];
                        } else if (line === 'KAT Alignment:') {
                            if (currentField === 'instructions') {
                                activity.instructions = currentContent.join('\n');
                            }
                            currentField = 'kat_alignment';
                            currentContent = [];
                        } else if (line === 'SLS Tools:') {
                            if (currentField === 'kat_alignment') {
                                activity.kat_alignment = currentContent.join('\n');
                            }
                            currentField = 'sls_tools';
                            currentContent = [];
                        } else if (line === 'Data Analysis:') {
                            if (currentField === 'sls_tools') {
                                activity.sls_tools = currentContent.join('\n');
                            }
                            currentField = 'data_analysis';
                            currentContent = [];
                        } else if (line === 'Teaching Notes:') {
                            if (currentField === 'data_analysis') {
                                activity.data_analysis = currentContent.join('\n');
                            }
                            currentField = 'teaching_notes';
                            currentContent = [];
                        } else if (line && !line.startsWith('---')) {
                            currentContent.push(line);
                        }
                    }
                    
                    // Save the last field
                    if (currentField === 'teaching_notes') {
                        activity.teaching_notes = currentContent.join('\n');
                    } else if (currentField === 'data_analysis') {
                        activity.data_analysis = currentContent.join('\n');
                    } else if (currentField === 'sls_tools') {
                        activity.sls_tools = currentContent.join('\n');
                    } else if (currentField === 'kat_alignment') {
                        activity.kat_alignment = currentContent.join('\n');
                    } else if (currentField === 'instructions') {
                        activity.instructions = currentContent.join('\n');
                    } else if (currentField === 'learning_objectives') {
                        activity.learning_objectives = currentContent.filter(l => l.startsWith('‚Ä¢')).map(l => l.substring(1).trim());
                    }
                    
                    // Assign section if missing
                    if (!activity.section) {
                        const match = activity.title.match(/Activity\s*(\d+)/i);
                        if (match) {
                            const activityNum = parseInt(match[1]);
                            const sectionNum = Math.ceil(activityNum / 2);
                            activity.section = `Section ${sectionNum}`;
                        }
                    }
                    
                    extractedData.activities.push(activity);
                    console.log('Added activity:', activity.title, 'for', activity.section);
                });
            }
            
            console.log('Extraction complete:');
            console.log('- SLS Tools found:', extractedData.selected_sls_tools.length);
            console.log('- KAT items found:', extractedData.recommended_kat.length);
            console.log('- Activities found:', extractedData.activities.length);
            
            return extractedData;
        }

        function generateStructuredActivitiesTable(structuredData) {
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">';
            
            // SLS Tools Section
            if (structuredData.selected_sls_tools && structuredData.selected_sls_tools.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üõ†Ô∏è Selected SLS Tools for This Lesson</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                `;
                structuredData.selected_sls_tools.forEach(tool => {
                    if (tool.trim()) {
                        html += `<div style="margin-bottom: 8px;">${tool}</div>`;
                    }
                });
                html += '</div></div>';
            }
            
            // KAT Section
            if (structuredData.recommended_kat && structuredData.recommended_kat.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Recommended Key Applications of Technology (KAT)</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                `;
                structuredData.recommended_kat.forEach(kat => {
                    if (kat.trim()) {
                        html += `<div style="margin-bottom: 8px;">${kat}</div>`;
                    }
                });
                html += '</div></div>';
            }
            
            // Group activities by section
            if (structuredData.activities && structuredData.activities.length > 0) {
                html += `<h3 style="color: #667eea; margin-bottom: 15px;">üìã Lesson Plan Activities by Section</h3>`;
                
                // Group activities by section
                const activitiesBySection = groupActivitiesBySection(structuredData.activities);
                
                // Display each section with its activities
                Object.keys(activitiesBySection).forEach(sectionName => {
                    const sectionActivities = activitiesBySection[sectionName];
                    
                    html += `
                        <div style="margin-bottom: 30px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; font-weight: bold; font-size: 1.1em;">
                                üìù ${sectionName || 'Section ' + (Object.keys(activitiesBySection).indexOf(sectionName) + 1)}
                                <span style="float: right; font-size: 0.9em; opacity: 0.9;">${sectionActivities.length} ${sectionActivities.length === 1 ? 'Activity' : 'Activities'}</span>
                            </div>
                            <table class="lesson-table" style="margin: 0; border-radius: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 12%;">Interaction</th>
                                        <th style="width: 10%;">Duration</th>
                                        <th style="width: 50%;">Activity Details</th>
                                        <th style="width: 28%;">SLS Tools & Analysis</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sectionActivities.forEach(activity => {
                        html += `
                            <tr>
                                <td>${formatInteractionCell(activity.interaction_type)}</td>
                                <td>${formatDurationCell(activity.duration)}</td>
                                <td><div class="activity-details">${formatStructuredActivityDetails(activity)}</div></td>
                                <td>${formatStructuredSLSTools(activity)}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                });
            }
            
            html += '</div>';
            return html;
        }

        function groupActivitiesBySection(activities) {
            const grouped = {};
            
            activities.forEach(activity => {
                const sectionName = activity.section || 'Unassigned Section';
                
                if (!grouped[sectionName]) {
                    grouped[sectionName] = [];
                }
                grouped[sectionName].push(activity);
            });
            
            // Sort sections naturally (Section 1, Section 2, etc.)
            const sortedGroups = {};
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                // Extract section numbers for natural sorting
                const aMatch = a.match(/Section\s*(\d+)/i);
                const bMatch = b.match(/Section\s*(\d+)/i);
                
                if (aMatch && bMatch) {
                    return parseInt(aMatch[1]) - parseInt(bMatch[1]);
                }
                
                // Fallback to alphabetical sorting
                return a.localeCompare(b);
            });
            
            // Sort activities within each section by activity number
            sortedKeys.forEach(key => {
                const sectionActivities = grouped[key];
                
                // Sort activities by extracting activity number from title
                sectionActivities.sort((a, b) => {
                    const aMatch = a.title.match(/Activity\s*(\d+)/i);
                    const bMatch = b.title.match(/Activity\s*(\d+)/i);
                    
                    if (aMatch && bMatch) {
                        return parseInt(aMatch[1]) - parseInt(bMatch[1]);
                    }
                    
                    // Fallback to alphabetical sorting by title
                    return a.title.localeCompare(b.title);
                });
                
                sortedGroups[key] = sectionActivities;
            });
            
            return sortedGroups;
        }

        function formatStructuredActivityDetails(activity) {
            let html = '';
            
            // Activity Title
            if (activity.title) {
                html += `<div class="activity-title">${activity.title}</div>`;
            }
            
            // Section
            if (activity.section) {
                html += `<div style="margin-top: 10px;"><strong>Section:</strong> ${activity.section}</div>`;
            }
            
            // Learning Objectives
            if (activity.learning_objectives && activity.learning_objectives.length > 0) {
                html += '<div style="margin-top: 15px;"><strong>Learning Objectives:</strong></div>';
                activity.learning_objectives.forEach(objective => {
                    html += `<div style="margin-left: 10px;">‚Ä¢ ${objective}</div>`;
                });
            }
            
            // Instructions
            if (activity.instructions) {
                html += '<div style="margin-top: 15px;"><strong>Instructions:</strong></div>';
                html += `<div style="margin-left: 10px;">${activity.instructions.replace(/\n/g, '<br>')}</div>`;
            }
            
            // KAT Alignment
            if (activity.kat_alignment) {
                html += '<div style="margin-top: 15px;"><strong>KAT Alignment:</strong></div>';
                let katText = activity.kat_alignment
                    .replace(/\bEmbed scaffolding\b/g, '<span class="kat-highlight">Embed scaffolding</span>')
                    .replace(/\bFacilitate learning together\b/g, '<span class="kat-highlight">Facilitate learning together</span>')
                    .replace(/\bFoster conceptual change\b/g, '<span class="kat-highlight">Foster conceptual change</span>')
                    .replace(/\bSupport assessment for learning\b/g, '<span class="kat-highlight">Support assessment for learning</span>')
                    .replace(/\bDevelop metacognition\b/g, '<span class="kat-highlight">Develop metacognition</span>')
                    .replace(/\bProvide differentiation\b/g, '<span class="kat-highlight">Provide differentiation</span>')
                    .replace(/\bEnable personalization\b/g, '<span class="kat-highlight">Enable personalization</span>')
                    .replace(/\bIncrease motivation\b/g, '<span class="kat-highlight">Increase motivation</span>')
                    .replace(/\n/g, '<br>');
                html += `<div style="margin-left: 10px;">${katText}</div>`;
            }
            
            // Teaching Notes
            if (activity.teaching_notes) {
                html += '<div style="margin-top: 15px;"><strong>Teaching Notes:</strong></div>';
                html += `<div style="margin-left: 10px;">${activity.teaching_notes.replace(/\n/g, '<br>')}</div>`;
            }
            
            return html;
        }

        function formatStructuredSLSTools(activity) {
            let html = '';
            
            // SLS Tools
            if (activity.sls_tools) {
                html += '<div class="sls-tools">';
                html += '<div><strong>SLS Tools:</strong></div>';
                html += `<div>${activity.sls_tools.replace(/\n/g, '<br>')}</div>`;
                html += '</div>';
            }
            
            // Data Analysis
            if (activity.data_analysis) {
                html += '<div class="data-analysis">';
                html += '<strong>üìä Data Analysis:</strong>';
                html += `<div>${activity.data_analysis.replace(/\n/g, '<br>')}</div>`;
                html += '</div>';
            }
            
            return html;
        }

        function generateReasoningSection(title, summary) {
            if (!summary) return '';
            return `
                <div class="reasoning-section">
                    <div class="reasoning-title">üß† AI Reasoning: ${title}</div>
                    <div>${summary}</div>
                </div>
            `;
        }

        function parseAndFormatActivities(content) {
            // Look for the table header pattern
            if (content.includes('LESSON PLAN TABLE:') && content.includes('| Interaction') && content.includes('| Duration') && content.includes('| Activity Details') && content.includes('| Suggested SLS Tools |')) {
                return formatMarkdownTable(content);
            } else {
                // Fallback to formatted text
                return `<div style="white-space: pre-wrap; line-height: 1.6;">${formatContent(content)}</div>`;
            }
        }

        function formatMarkdownTable(content) {
            const lines = content.split('\n');
            let tableStartIndex = -1;
            let headerIndex = -1;
            
            // Find the table header
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('| Interaction') && lines[i].includes('| Duration') && lines[i].includes('| Activity Details') && lines[i].includes('| Suggested SLS Tools |')) {
                    headerIndex = i;
                    tableStartIndex = i + 2; // Skip the separator line
                    break;
                }
            }
            
            if (headerIndex === -1) {
                return `<div style="white-space: pre-wrap; line-height: 1.6;">${formatContent(content)}</div>`;
            }
            
            // Extract pre-table content (everything before the header)
            const preTableContent = lines.slice(0, headerIndex).join('\n');
            
            // Parse the table data starting from after the separator
            const tableData = parseTableData(lines, tableStartIndex);
            
            // Create the HTML table
            let html = `
                <div style="white-space: pre-wrap; line-height: 1.6; margin-bottom: 20px;">
                    ${formatContent(preTableContent)}
                </div>
                <table class="lesson-table">
                    <thead>
                        <tr>
                            <th>Interaction</th>
                            <th>Duration</th>
                            <th>Activity Details</th>
                            <th>Suggested SLS Tools</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add table rows
            tableData.forEach(row => {
                html += `
                    <tr>
                        <td>${formatInteractionCell(row.interaction)}</td>
                        <td>${formatDurationCell(row.duration)}</td>
                        <td><div class="activity-details">${formatActivityDetails(row.activityDetails)}</div></td>
                        <td>${formatSLSTools(row.slsTools)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            return html;
        }

        function parseTableData(lines, startIndex) {
            const rows = [];
            let currentRow = {
                interaction: '',
                duration: '',
                activityDetails: '',
                slsTools: ''
            };
            let inRow = false;
            let currentContent = '';
            
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i];
                
                // Check if this is the start of a new table row
                if (line.match(/^\|\s*(Student-Content|Student-Student|Teacher-Student|Student-Community)/)) {
                    // Save previous row if it exists
                    if (inRow && currentRow.interaction) {
                        rows.push({...currentRow});
                    }
                    
                    // Parse the new row
                    const cells = parseTableLine(line);
                    if (cells.length >= 4) {
                        currentRow = {
                            interaction: cells[0],
                            duration: cells[1],
                            activityDetails: cells[2],
                            slsTools: cells[3]
                        };
                        inRow = true;
                    }
                }
                // Check if this line continues the activity details or SLS tools
                else if (inRow && line.trim() && !line.startsWith('|') && !line.match(/^[-|]+$/)) {
                    // This is continuation content - add to activity details
                    currentRow.activityDetails += '\n' + line;
                }
                // Check if this is an empty line or end of table
                else if (!line.trim() || (!line.includes('|') && line.trim() !== '')) {
                    if (inRow && currentRow.interaction) {
                        rows.push({...currentRow});
                        inRow = false;
                        currentRow = {
                            interaction: '',
                            duration: '',
                            activityDetails: '',
                            slsTools: ''
                        };
                    }
                    // If this is a non-empty line that doesn't contain |, we've reached the end of the table
                    if (line.trim() && !line.includes('|')) {
                        break;
                    }
                }
            }
            
            // Don't forget the last row
            if (inRow && currentRow.interaction) {
                rows.push(currentRow);
            }
            
            return rows;
        }

        function parseTableLine(line) {
            // Split by | and clean up
            const parts = line.split('|');
            const cells = [];
            
            for (let i = 1; i < parts.length - 1; i++) { // Skip first empty and last empty
                cells.push(parts[i].trim());
            }
            
            return cells;
        }

        function formatInteractionCell(interaction) {
            const type = interaction.toLowerCase().replace(/[^a-z-]/g, '');
            return `<span class="interaction-badge ${type}">${interaction}</span>`;
        }

        function formatDurationCell(duration) {
            return `<span class="duration-badge">${duration}</span>`;
        }

        function formatActivityDetails(details) {
            if (!details) return '';
            
            // Clean up the details text
            let formatted = details.trim();
            
            // Format different sections with proper structure
            formatted = formatted
                // Bold activity titles - more flexible pattern
                .replace(/(Activity #\d+[^:\n]*:?[^\n]*)/g, '<div class="activity-title">$1</div>')
                // Format section headers
                .replace(/^Learning Objectives:\s*$/gm, '<div style="margin-top: 15px;"><strong>Learning Objectives:</strong></div>')
                .replace(/^Instructions:\s*$/gm, '<div style="margin-top: 15px;"><strong>Instructions:</strong></div>')
                .replace(/^KAT Alignment:\s*$/gm, '<div style="margin-top: 15px;"><strong>KAT Alignment:</strong></div>')
                .replace(/^Teaching Notes:\s*$/gm, '<div style="margin-top: 15px;"><strong>Teaching Notes:</strong></div>')
                // Format numbered lists
                .replace(/^(\d+\.\s)/gm, '<br>$1')
                // Format bullet points
                .replace(/^‚Ä¢\s*/gm, '<br>‚Ä¢ ')
                // Format KAT highlights - exact text matching
                .replace(/\bEmbed scaffolding\b/g, '<span class="kat-highlight">Embed scaffolding</span>')
                .replace(/\bFacilitate learning together\b/g, '<span class="kat-highlight">Facilitate learning together</span>')
                .replace(/\bFoster conceptual change\b/g, '<span class="kat-highlight">Foster conceptual change</span>')
                .replace(/\bSupport assessment for learning\b/g, '<span class="kat-highlight">Support assessment for learning</span>')
                .replace(/\bDevelop metacognition\b/g, '<span class="kat-highlight">Develop metacognition</span>')
                .replace(/\bProvide differentiation\b/g, '<span class="kat-highlight">Provide differentiation</span>')
                .replace(/\bEnable personalization\b/g, '<span class="kat-highlight">Enable personalization</span>')
                .replace(/\bIncrease motivation\b/g, '<span class="kat-highlight">Increase motivation</span>')
                // Convert line breaks to HTML
                .replace(/\n/g, '<br>');
            
            return formatted;
        }

        function formatSLSTools(tools) {
            if (!tools) return '';
            
            let formatted = tools.trim();
            let html = '';
            
            // Check if there's a "Data Analysis:" section
            if (formatted.includes('Data Analysis:')) {
                const parts = formatted.split('Data Analysis:');
                
                html += '<div class="sls-tools">';
                html += '<div><strong>SLS Tools:</strong></div>';
                html += `<div>${parts[0].trim().replace(/\n/g, '<br>')}</div>`;
                html += '</div>';
                
                if (parts[1] && parts[1].trim()) {
                    html += '<div class="data-analysis">';
                    html += '<strong>üìä Data Analysis:</strong>';
                    html += `<div>${parts[1].trim().replace(/\n/g, '<br>')}</div>`;
                    html += '</div>';
                }
            } else {
                html = `<div class="sls-tools">${formatted.replace(/\n/g, '<br>')}</div>`;
            }
            
            return html;
        }

        function formatContent(content) {
            if (!content) return '';
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function formatContentWithPlanHighlights(content) {
            if (!content) return '';
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Highlight KAT terms
                .replace(/\b(Foster conceptual change|Support assessment for learning|Facilitate learning together|Develop metacognition|Provide differentiation|Embed scaffolding|Enable personalization|Increase motivation)\b/g, '<span class="plan-highlight">$1</span>')
                // Highlight section headers
                .replace(/^(LESSON OVERVIEW|RECOMMENDED KEY APPLICATIONS|PEDAGOGICAL APPROACH|HIGH-LEVEL SECTION BREAKDOWN|ASSESSMENT STRATEGY|POTENTIAL SLS TOOLS):/gm, '<strong style="color: #667eea; font-size: 1.1em;">$1:</strong>')
                .replace(/\n/g, '<br>');
        }

        function generateErrorsSection(errors) {
            const errorItems = Object.entries(errors)
                .filter(([key, value]) => value)
                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                .join('');
            
            if (!errorItems) return '';
            
            return `
                <div class="section-header" style="background: #dc3545;">‚ö†Ô∏è Errors</div>
                <div class="error-message">
                    ${errorItems}
                </div>
            `;
        }

        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            content.classList.remove('hidden');
        }
    </script>
</body>
</html> 